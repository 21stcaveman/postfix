<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>

<head>

<title>Postfix LMTP Howto</title>

<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">

</head>

<body>

<h1><img src="postfix-logo.jpg" width="203" height="98" ALT="">Postfix LMTP Howto</h1>

<hr>

<h2>Introduction</h2>

<p> This document describes mail delivery via LMTP including Cyrus
IMAP.  For an overview of all methods to host domains with Postfix,
see the <a href="VIRTUAL_README.html">VIRTUAL_README</a> file.  </p>

<p> LMTP stands for Local Mail Transfer Protocol, and is detailed
in <a href="http://www.faqs.org/rfcs/rfc2033.html">RFC2033</a>.  Postfix uses this protocol to communicate with the
final delivery agent, which may run on the local host or a remote
host. </p>

<p> This protocol opens up interesting possibilities: one Postfix
front end machine can drive multiple mailbox back end machines over
LMTP.  As the mail load increases, you add more Postfix front end
systems and more LMTP mailbox back end systems.  This is the model
that Wietse had in mind when he began drafting the design for
Postfix - a scalable architecture that allows you to keep adding
SMTP servers and mailbox servers painlessly. </p>

<p> Of course such a distributed architecture needs glue to keep
things together.  You can use <b>rsync</b> when configuration files
are small and/or when their information does not change often.  Or
you can use a networked database (see <a href="LDAP_README.html">LDAP_README</a>, <a href="MYSQL_README.html">MYSQL_README</a> or
<a href="PGSQL_README.html">PGSQL_README</a>) to share the user database among the front end and
back end systems.  If you take this route, be sure to use a replicated
database so that no machine becomes a single point of failure for
the entire mail infrastructure. </p>

<p> Postfix LMTP support is based on a modified version of the
Postfix SMTP client. The initial version was by Philip A.  Prindeville
of Mirapoint, Inc., USA. This code was modified further by Amos
Gouaux of University of Texas at Dallas, Richardson, USA, who also
revised much of the documentation.  Wietse Venema reduced the code
to its present shape.  </p>

<h2>Overview</h2>

<p> Most of the examples in this document involve the CMU Cyrus
IMAP/POP server, available from <a href="http://asg.web.cmu.edu/cyrus/.">http://asg.web.cmu.edu/cyrus/.</a> </p>

<p> While certainly not the only application that could make use
of LMTP, it tends to be the most discussed.  These examples are
based on Cyrus 2.1.5.  The 2.x branch of Cyrus places greater
emphasis on LMTP delivery than the previous releases.  Those using
older releases of Cyrus can find a discussion in the appendix of
this document. </p>

<p> There are a variety of ways LMTP delivery can be configured in
Postfix.  The two basic flavors are delivery over UNIX-domain
sockets and delivery over TCP sockets. </p>

<ul>

    <li> <p> Connections from the Postfix LMTP client over <a
    href="#lmtp_unix"> UNIX-domain sockets </a> allow you to deliver
    to non-Postfix LMTP servers running on the same machine.  </p>

    <p> Note: these are not to be confused with the UNIX-domain
    sockets that Postfix uses internally, as configured in the
    master.cf file. </p>

    <li> <p> Connections from the Postfix LMTP client over <a
    href="#lmtp_tcp"> TCP sockets </a> allow you to deliver to
    non-Postfix LMTP servers across a local network. </p>

</ul>

<p> The precise syntax for UNIX-domain and TCP connection endpoints
is given in the <a href="lmtp.8.html">lmtp(8)</a> manual page. Examples are also given in
the text below. </p>

<p> You also have multiple options for the path that local mail
follows through Postfix. What is the best approach for you depends
upon the arrangement of your servers: </p>

<ul>

    <li> <p> Mail is given to the <a href="local.8.html">local(8)</a> delivery agent which
    passes it to the <a href="lmtp.8.html">lmtp(8)</a> client for mailbox delivery.  This is
    less efficient, but gives you local <a href="aliases.5.html">aliases(5)</a> and ~/.forward
    file processing. This approach is called <a href="#indirect">
    indirect delivery via the local delivery agent </a>.  </p>

    <li> <p> Mail is given directly to the Postfix LMTP client.
    Postfix does not invoke the <a href="local.8.html">local(8)</a> delivery agent, so you
    have no local <a href="aliases.5.html">aliases(5)</a> and no ~/.forward file processing.
    This approach is called <a href="#direct"> direct delivery
    without the local delivery agent</a>.  </p>

</ul>

<p> The following topics are covered in this document: </p>

<ul>

<li><a href="#lmtp_unix">LMTP over UNIX-domain sockets</a>

<li><a href="#lmtp_tcp">LMTP over TCP sockets</a>

<li><a href="#indirect">Indirect LMTP delivery via the local delivery
agent</a>

<li><a href="#direct">Direct LMTP delivery without the local delivery
agent</a>

<li><a href="#performance">Performance considerations</a>

<li><a href="#single_instance">Single instance message store</a>

<li><a href="#conn_caching">Improving connection caching performance</a>

<li><a href="#old_cyrus">Appendix: Older Cyrus versions</a>

</ul>

<h2><a name="lmtp_unix">LMTP over UNIX-domain sockets</a></h2>

<p> Use this to deliver mail from the Postfix LMTP client to an LMTP
server that is running on the same system. </p>

<p> A UNIX-domain socket is specified as the socket type ("unix") and
a name in the local file system: </p>

<blockquote>
<pre>
unix:/path/name
</pre>
</blockquote>

<p> The "/path/name" part should be the name of a socket created
by the LMTP server on the local machine. See the specific examples
later in this document. </p>

<dl>

<dt>NOTE:

    <dd> <p> If you run the Postfix LMTP client chrooted, the
    interpretation of the /path/name is relative to the Postfix
    queue directory (typically, /var/spool/postfix). </p>

    <dd> <p> By default, the Postfix LMTP client does not run
    chrooted.  With LMTP delivery to the local machine there is no
    good reason to run the Postfix LMTP client chrooted. </p>

</dl>

<h2><a name="lmtp_tcp">LMTP over TCP sockets</a></h2>

Use this to deliver mail from the Postfix LMTP client to an LMTP
server that is running on the same system or on a different system.

<p>

A TCP destination is specified as the socket type ("inet"), the
destination hostname and the TCP port:

<blockquote>
<pre>
inet:hostname:port
</pre>
</blockquote>

The "inet:" part can be omitted, as it is the default socket type.

<p> The destination port can be omitted as well. Currently the default
TCP port number for this type of connection is 24, but this can be
customized in the /etc/services file.  Specific examples are
given later in this document. </p>

<dl>

<dt> NOTE:

    <dd> <p> With connections over TCP sockets, Cyrus 2.0.x LMTP
    server implementations insisted on SASL-style authentication.
    This meant that Postfix had to be built with SASL support (see
    <a href="SASL_README.html">SASL_README</a>).  While newer Cyrus releases offer an option to
    turn off this requirement, you must exercise great care in both
    determining the approach used and the configuration of your
    selection.  It is imperative that you do not allow unauthorized
    access to your LMTP server.  The examples below show both
    approaches. </p>

    <dd> <p> Some Cyrus LMTP server implementations do not allow
    SASL-style authentication via plaintext passwords over unencrypted
    connections.  This is not the case with 2.1.5.  However, you
    must realize that this could make your LMTP link vulnerable.
    If your LMTP communications traverse exposed networks, you
    should either use an encrypted connection or enable MD5 SASL
    mechanisms. </p>

</dl>

<h2><a name="indirect">Indirect LMTP delivery via the local delivery
agent</a></h2>

This is the simplest LMTP configuration.  

<h2>Local delivery agent configurations</h2>

<p> The Postfix local delivery agent supports two mechanisms that
we can use to delegate mailbox delivery to the LMTP client. In both
cases, mail for non-UNIX accounts is always given to the LMTP client.
The approaches differ only in the way that mail for UNIX accounts
is delivered. One delivers to the UNIX system mailbox, the other
to the LMTP client.  Both always delegate non-UNIX accounts to the
LMTP client.  Each method can use UNIX-domain or TCP sockets as
described in a later section.  </p>

<ul>

<li> <p> Indirect LMTP delivery configured with the <a href="postconf.5.html#mailbox_transport">mailbox_transport</a>
parameter. </p>

<p> Mail that resolves as local (domain is listed in $<a href="postconf.5.html#mydestination">mydestination</a>
or matches the IP addresses listed in $<a href="postconf.5.html#inet_interfaces">inet_interfaces</a> or
$<a href="postconf.5.html#proxy_interfaces">proxy_interfaces</a>) is given to the Postfix local delivery agent.
The Postfix local delivery agent expands aliases, .forward files
(only if the recipient has a UNIX account), and delegates all
mailbox delivery to the Postfix LMTP client which then sends it to
the non-Postfix LMTP server. </p>

<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = <a href="lmtp.8.html">lmtp</a>:unix:/path/name (UNIX-domain socket example)
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = <a href="lmtp.8.html">lmtp</a>:hostname:port   (TCP socket example)
</pre>

<li> <p> Indirect LMTP delivery configured with the <a href="postconf.5.html#fallback_transport">fallback_transport</a>
parameter. </p>

<p> Mail that resolves as local (domain is listed in $<a href="postconf.5.html#mydestination">mydestination</a>
or matches the IP addresses listed in $<a href="postconf.5.html#inet_interfaces">inet_interfaces</a> or
$<a href="postconf.5.html#proxy_interfaces">proxy_interfaces</a>) is given to the Postfix local delivery agent.
The Postfix local delivery agent processes aliases and .forward
files, and delivers to /var[/spool]/mail/$user etc. for users that
have a UNIX account.  Mail for non-UNIX local users is delegated
to the Postfix LMTP client which then sends it to the non-Postfix
LMTP server. </p>

<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#fallback_transport">fallback_transport</a> = <a href="lmtp.8.html">lmtp</a>:unix:/path/name (UNIX-domain socket example)
    <a href="postconf.5.html#fallback_transport">fallback_transport</a> = <a href="lmtp.8.html">lmtp</a>:hostname:port   (TCP socket example)
</pre>

</ul>

<h2>Delivery via the local delivery agent: LMTP over UNIX-domain sockets</h2>

<p> To utilize UNIX-domain sockets for the communication between
Postfix and Cyrus, the corresponding configuration files should
look something like this: </p>

<blockquote>
<pre>
/etc/cyrus.conf:
    SERVICES { 
      ... 
      lmtpunix cmd="lmtpd" listen="/var/imap/socket/lmtp" prefork=1
      ... 
    } 

/etc/postfix/main.cf:
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = <a href="lmtp.8.html">lmtp</a>:unix:/var/imap/socket/lmtp

/etc/postfix/master.cf:
    lmtp      unix  -       -       n       -       -       lmtp
</pre>
</blockquote>

<p> In this case, the Postfix local delivery agent expands aliases
and .forward files, and delegates mailbox delivery to the Cyrus
lmtpd server via the socket "/var/imap/socket/lmtp". </p>

<dl>

<dt> NOTE:

<dd> <p> Make sure that both the user id that Cyrus runs under and
the Postfix user id can access the socket "/var/imap/socket/lmtp".
While this is implied by the example above, it is often overlooked
and so warrants emphasis. </p>

</dl>

<h2>Delivery via the local delivery agent: LMTP over TCP sockets (non-SASL)</h2>

<p> For this example, suppose the following files are configured
thusly:  </p>

<blockquote>
<pre>
/etc/cyrus.conf:
    SERVICES { 
      ... 
      lmtp cmd="lmtpd -a" listen="127.0.0.1:lmtp" prefork=1 
      ... 
    } 

/etc/services:
    lmtp 2003/tcp

/etc/postfix/main.cf:
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = <a href="lmtp.8.html">lmtp</a>:localhost

/etc/postfix/master.cf:
    lmtp      unix  -       -       n       -       -       lmtp
</pre>
</blockquote>

<p> With the above settings, the Postfix local delivery agent
expands aliases and .forward files, and delegates mailbox delivery
to the Cyrus LMTP server.  Postfix makes a connection to port 2003
on the local host, subsequently transmitting the message to the
lmtpd server managed by the Cyrus master process.  The port number
has been changed in /etc/services from 24 to 2003 as that is what
the Cyrus LMTP server is now using. </p>

<p> See the Cyrus <b>lmtpd</b> man page to verify that the version
you have supports the "<b>-a</b>" option. </p>

<dl>

<dt> NOTE:

    <dd> <p> Consider this approach if and only if this particular
    host does not allow direct user logins or user-controlled
    processes.  Otherwise, this LMTP server may be abused! </p>
    
    <dd> <p> If the Cyrus lmtp service is to listen on a network
    other than the local loop-back (127.0.0.1), be sure to install
    Cyrus with tcp_wrappers support.  Then use tcp_wrappers to only
    allow access to the "lmtp" service from trusted hosts.  Otherwise,
    this LMTP server may be abused! </p>

    <dd> <p> The <a href="#old_cyrus">Appendix</a> contains an
    example using tcp_wrappers.  For the configuration above,
    replace "deliver" with "lmtp" in the /etc/hosts.allow shown in
    that example.  </p>

</dl>

<h2>Delivery via the local delivery agent: LMTP over TCP sockets (SASL)</h2>

<p> In the following example "cyhost.my.domain" is the name of the
Cyrus IMAP/POP server.  It is important that you use this name
consistently in the Postfix configuration settings.  The first
approach uses the PLAIN authentication mechanism (see the Cyrus
SASL documentation.) </p>

<p> Suppose the Cyrus server has the following files configured
thusly: </p>

<blockquote>
<pre>
/etc/cyrus.conf:
    SERVICES { 
      ... 
      lmtp cmd="lmtpd" listen="cyhost.my.domain:lmtp" prefork=1
      ... 
    } 

/etc/imapd.conf:
    lmtp_admins: lmtpuser
/etc/services:
    lmtp 2003/tcp
</pre>
</blockquote>

<p> The Postfix host (may be same box) has the following configuration:
</p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = <a href="lmtp.8.html">lmtp</a>:cyhost.my.domain
    <a href="postconf.5.html#lmtp_sasl_auth_enable">lmtp_sasl_auth_enable</a> = yes
    <a href="postconf.5.html#lmtp_sasl_password_maps">lmtp_sasl_password_maps</a> = hash:/etc/postfix/lmtp_sasl_pass
    <a href="postconf.5.html#lmtp_sasl_security_options">lmtp_sasl_security_options</a> = noanonymous

/etc/postfix/lmtp_sasl_pass:
    cyhost.my.domain    lmtpuser:password

/etc/services:
    lmtp 2003/tcp

/etc/postfix/master.cf:
    lmtp      unix  -       -       n       -       -       lmtp
</pre>
</blockquote>

<p> Instead of "<b>hash</b>", use the map type of your choice.
Some systems use "<b>dbm</b>" instead.  Use "<b>postconf -m</b>"
to find out what map types are supported. </p>

<p> If your version of Cyrus does not support "lmtp_admins" as a
setting in imapd.conf, use "admins" instead. </p>

<p> With the above settings, the Postfix local delivery agent
expands aliases and .forward files, and delegates mailbox delivery
to the Cyrus LMTP server.  Postfix makes a connection to port 2003
on the local host, subsequently transmitting the message to the
lmtpd server managed by the Cyrus master process.  The port number
has been changed in /etc/services from 24 to 2003 as that is what
the Cyrus LMTP server is now using.  The SASL configuration on the
Cyrus server will need to accept the user "lmtpuser" using the
password specified in /etc/postfix/lmtp_sasl_pass on the Postfix
host. </p>

<p> If this LMTP conduit exists over an exposed network, you should
compile Postfix with MD5 (CRAM or DIGEST) password support.  See
<a href="SASL_README.html">SASL_README</a> for more details.  Then configure Postfix as follows:
</p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#lmtp_sasl_security_options">lmtp_sasl_security_options</a> = noanonymous, noplaintext
</pre>
</blockquote>

<p> On the Cyrus host you should also set: </p>

<blockquote>
<pre>
/etc/imapd.conf:
    lmtp_allowplaintext: no
</pre>
</blockquote>

<p> You will need to make sure the "lmtpuser" is in the appropriate
SASL database.  As an example, the following would add "lmtpuser"
to /etc/sasldb2: </p>

<blockquote>
<pre>
saslpasswd2 -c -u cyhost.my.domain lmtpuser
</pre>
</blockquote>

<p> If you encounter difficulties with "lmtpuser" not being permitted
to authenticate to the LMTP server, try the above command with the
un-qualified hostname: </p>

<blockquote>
<pre>
saslpasswd2 -c -u cyhost lmtpuser
</pre>
</blockquote>

<p> Also make sure the Cyrus user has read permission of the SASL
database, /etc/sasldb2 in the example above. </p>

<p> Incidentally, it is very likely that the Cyrus server and the
Postfix server will need to use the same SASL backend databases
(e.g., auxprop or saslauthd.)  Currently it is not possible to
assign different SASL backends for different Cyrus services.  Only
TLS (SSL) or STARTTLS can be used in conjunction with saslauthd.
Since none of these encryption methods are available for LMTP, if
you need to encrypt your LMTP connections, you will very likely
have to use auxprop throughout. </p>

<h2><a name="direct">Direct LMTP delivery without the local delivery
agent</a></h2>

<p> In the examples presented here we bypass the <a href="local.8.html">local(8)</a> delivery
agent altogether. This means there will be no <a href="aliases.5.html">aliases(5)</a> or .forward
file expansion. </p>

<ul>

<li> <p> Direct LMTP delivery configured with the <a href="postconf.5.html#local_transport">local_transport</a>
parameter. </p>

<p> In the first example we change the <a href="postconf.5.html#local_transport">local_transport</a> configuration
parameter. Normally this parameter specifies the <a href="local.8.html">local(8)</a> delivery
agent.  When we change it to the Postfix LMTP client, mail that
resolves as local (domain is listed in $<a href="postconf.5.html#mydestination">mydestination</a> or matches
the IP addresses listed in $<a href="postconf.5.html#inet_interfaces">inet_interfaces</a> or $<a href="postconf.5.html#proxy_interfaces">proxy_interfaces</a>)
is now given directly to the Postfix LMTP client.  This client in
turn sends sends the mail to the non-Postfix LMTP server.

<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#local_transport">local_transport</a> = <a href="lmtp.8.html">lmtp</a>:unix:/path/name (UNIX-domain socket example)
    <a href="postconf.5.html#local_transport">local_transport</a> = <a href="lmtp.8.html">lmtp</a>:hostname:port   (TCP socket example)
</pre>

<li> <p> Direct LMTP delivery configured with the <a href="postconf.5.html#transport_maps">transport_maps</a>
parameter. </p>

<p> The second example is different from all the previous ones, in
that it uses a transport map to route mail for a specific domain
to its appropriate LMTP server.  Why might this approach be useful?
This could be handy if you wish to route mail for multiple domains
to their respective mail retrieval (IMAP/POP) server.  Example:
</p>

<pre>
/etc/postfix/transport:
    domain1.tld         lmtp1:unix:/path/name
    domain2.tld         lmtp2:lmtp2host

/etc/postfix/master.cf:
    lmtp1      unix  -       -       n       -       -       lmtp
    lmtp2      unix  -       -       n       -       -       lmtp

/etc/postfix/main.cf:
    <a href="postconf.5.html#transport_maps">transport_maps</a> = hash:/etc/postfix/transport
</pre>

<p> For details of the Cyrus LMTP server configuration, see 
the examples in the sections on <a href="#indirect"> delivery
via the local delivery agent </a>. </p>

<p> Instead of "<b>hash</b>", use the map type of your choice.
Some systems use "<b>dbm</b>" instead.  Use "<b>postconf -m</b>"
to find out what map types are supported. </p>

</ul>

<h2><a name="performance">Performance considerations</a></h2>

<p> Hopefully the preceding discussion has seemed pretty straight
forward.  Now things get interesting.  After reading the following
you will see that there are more factors to consider when setting
up LMTP services. </p>

<h2><a name="single_instance">Single instance message store</a></h2>

<p> Presently this topic is more pertinent to sites running Cyrus,
but may be a factor with other applications as well. </p>

<p> Since version 1.6.22, Cyrus has had the feature that if a
message containing multiple recipients is received via the LMTP
protocol, and all these recipients were on the same Cyrus partition,
only one instance of this message would be written to the file
system.  The other recipients would then see a hard link of this
single instance.  Depending on your user base, this can be considerable
motivation to using LMTP. </p>

<dl>

<dt> NOTE:

    <dd> <p> This feature cannot be used with the Postfix <a href="local.8.html">local(8)</a>
    delivery agent's <b><a href="postconf.5.html#mailbox_transport">mailbox_transport</a></b> or <b><a href="postconf.5.html#fallback_transport">fallback_transport</a></b>
    mechanisms. These mechanisms always deliver recipients one at a time.
    </p>

</dl>

<p> If we wish to apply this single instance message store technique
with the <a href="#direct"> direct lmtp delivery </a>
example, the setting would be: </p>

<ul>

<li> <p> Direct LMTP delivery configured with the <a href="#indirect">
local transport </a> parameter:</p>

<pre>
/etc/postfix/main.cf:
    <a href="postconf.5.html#local_transport">local_transport</a> = <a href="lmtp.8.html">lmtp</a>:unix:/path/name (UNIX-domain socket example)
    <a href="postconf.5.html#local_transport">local_transport</a> = <a href="lmtp.8.html">lmtp</a>:hostname:port   (TCP socket example)
    <a href="postconf.5.html#local_destination_recipient_limit">local_destination_recipient_limit</a> = 300
</pre>

<li> <p> Direct LMTP delivery configured with the <a href="#direct">
transport </a> table:</p>

<pre>
/etc/postfix/main.cf:
    lmtp1_destination_recipient_limit = 300
    lmtp2_destination_recipient_limit = 300
</pre>

</ul>

<dl>

<dt>NOTE:

    <dd> <p> Postfix uses 50 as the default, which is probably
    sufficient to reap most of the benefit from single instance
    storage.  </p>

    <p> The 300 number was arbitrarily chosen for this example.
    Be sure to pick a number that is appropriate for the capabilities
    of your hardware. The bigger the number, the more you can
    leverage the single instance message store. However, if it is
    too big the LMTP server will need too much time to deliver a
    message and Postfix will experience timeout errors. Choose this
    value very carefully. </p>

</dl>

<h2><a name="conn_caching">Improving connection caching performance</a></h2>

<p> After delivering a message via LMTP, Postfix will keep the
connection open for a while, so that it can be reused for a subsequent
delivery.  This reduces overhead of LMTP servers that create one
process per connection. </p>

<p> For LMTP connection caching to work, the Postfix LMTP client
should not switch destination hosts.  This is no problem when you
run only one LMTP server. However, if you run multiple LMTP servers,
this can be an issue. </p>

<p> You can prevent the LMTP client from switching between servers by
configuring a separate LMTP delivery transport for each LMTP server: </p>

<blockquote>
<pre>
/etc/postfix/master.cf:
    lmtp1      unix  -       -       n       -       -       lmtp
    lmtp2      unix  -       -       n       -       -       lmtp
      .         .    .       .       .       .       .        .
</pre>
</blockquote>

<p> Configure transport table entries such that the lmtp1 mail
delivery transport is used for all deliveries to the LMTP server
#1, the mail lmtp2 transport for the LMTP server #2, and so on.
</p>

<blockquote>
<pre>
/etc/postfix/transport:
    foo.com lmtp1:lmtp1host
    bar.com lmtp2:lmtp2host
</pre>
</blockquote>

<h2><a name="old_cyrus">Appendix: Older Cyrus versions</a></h2>

<p> First of all, if you are using a Cyrus 2.x version prior to
2.1.4, you should really consider upgrading.  There have been
numerous bug fixes and performance improvements since the early
2.0 releases. </p>

<p> Further back, 1.6.24 was the last pre-2.x production release.
(Actually, there was a 1.6.25-BETA, but it is uncertain whether
this will be released officially as CMU is now focusing support on
the 2.x branch.)  The following discussion touches on how to
configure the Postfix LMTP facilities with Cyrus 1.6.24. </p>

<p> One of the significant differences between Cyrus 1.x and 2.x
is the inclusion of the "master" process in 2.x.  This "master"
process is responsible for running the various components of Cyrus,
such as imapd, pop3d, and lmtpd.  Prior to 2.x, these services were
managed by inetd, the Internet services daemon. </p>

<p> To utilize LMTP delivery with Cyrus 1.6.24, the first thing to
do is configure inetd.  This involves the following file edits:
</p>

<blockquote>
<pre>
/etc/services:
    lmtp 2003/tcp

/etc/inetd.conf:
    lmtp stream tcp nowait cyrus /usr/sbin/tcpd /usr/cyrus/bin/deliver -e -l

/etc/hosts.allow:
    deliver : localhost : ALLOW
    deliver : ALL@ALL : DENY
</pre>
</blockquote>

<p> The "/usr/sbin/tcpd" is from the tcp_wrappers package, which
is discussed in the example "LMTP over TCP sockets, using hosts.allow."
It is important that you wrap this LMTP port to protect it from
unauthorized access. </p>

<p> On some systems, tcpd is built into inetd, so you do not have
to specify tcpd in the inetd.conf file. Instead of tcpd/inetd,
xinetd can do a similar job of logging and access control. </p>

<p> Now comes the Postfix configuration.  Basically, the Cyrus 2.x
discussions regarding LMTP delivery over TCP are also applicable
to Cyrus 1.x, with the exception of the /etc/cyrus.conf file.  A
typical Postfix configuration might look like this: </p>

<blockquote>
<pre>
/etc/postfix/master.cf:
    lmtp      unix  -       -       n       -       -       lmtp

/etc/postfix/main.cf:
    <a href="postconf.5.html#mailbox_transport">mailbox_transport</a> = lmtp
</pre>
</blockquote>

<p> It is also possible to use the transport map to route mail to
your Cyrus 1.6.24 LMTP server: </p>

<blockquote>
<pre>
/etc/postfix/transport:
    domain1.tld         lmtp1:lmtp1host
    domain2.tld         lmtp2:lmtp2host

/etc/postfix/master.cf:
    lmtp1      unix  -       -       n       -       -       lmtp
    lmtp2      unix  -       -       n       -       -       lmtp

/etc/postfix/main.cf:
    <a href="postconf.5.html#transport_maps">transport_maps</a> = hash:/etc/postfix/transport
</pre>
</blockquote>

<p> If you have read the discussion covering the Cyrus 2.x
installation, you will notice the one significant difference with
the Postfix configuration is the lack of mention of the UNIX-domain
sockets.  That is because delivery over UNIX-domain sockets is new
with Cyrus 2.x, yet another reason to upgrade.  :-) </p>

</body>

</html>
