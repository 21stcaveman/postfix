<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html> <head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<title> </title>
</head> <body> <pre>
ANVIL(8)                                                 ANVIL(8)

<b>NAME</b>
       anvil - Postfix client count and rate management

<b>SYNOPSIS</b>
       <b>anvil</b> [generic Postfix daemon options]

<b>DESCRIPTION</b>
       The  Postfix  <b>anvil</b> server maintains short-term statistics
       to defend against clients that hammer a server with either
       too  many parallel connections or with too many successive
       connection attempts within a configurable  time  interval.
       This  server is designed to run under control by the Post-
       fix master server.

<b>PROTOCOL</b>
       When a remote client  connects,  a  connection  count  (or
       rate)  limited server should send the following request to
       the <b>anvil</b> server:

           <b>request=connect</b>
           <b>ident=</b><i>string</i>

       This registers a new connection for the (service,  client)
       combination specified with <b>ident</b>. The <b>anvil</b> server answers
       with the number of simultaneous connections and the number
       of  connections  per  unit time for that (service, client)
       combination:

           <b>status=0</b>
           <b>count=</b><i>number</i>
           <b>rate=</b><i>number</i>

       The <b>rate</b> is computed as the  number  of  connections  that
       were  registered  in the current "time unit" interval.  It
       is left up to the server to decide if  the  remote  client
       exceeds the connection count (or rate) limit.

       When  a  remote client disconnects, a connection count (or
       rate) limited server should send the following request  to
       the <b>anvil</b> server:

           <b>request=disconnect</b>
           <b>ident=</b><i>string</i>

       This  registers  a  disconnect  event  for  the  (service,
       client) combination specified with <b>ident</b>. The <b>anvil</b> server
       replies with:

           <b>status=0</b>

<b>SECURITY</b>
       The  <b>anvil</b> server does not talk to the network or to local
       users, and can run chrooted at fixed low privilege.

       The <b>anvil</b> server maintains an in-memory table with  infor-
       mation  about  recent  clients  of  a connection count (or
       rate) limited service.  Although state is kept  only  tem-
       porarily, this may require a lot of memory on systems that
       handle connections from many remote  clients.   To  reduce
       memory  usage,  reduce  the  time unit over which state is
       kept.

<b>DIAGNOSTICS</b>
       Problems and transactions are logged to <b>syslogd</b>(8).

       Upon exit, and every  <b>client_connection_status_update_time</b>
       seconds, the server logs the maximal count and rate values
       measured, together with (service, client) information  and
       the time of day associated with those events.

<b>BUGS</b>
       Systems  behind  network  address  translating  routers or
       proxies appear to have the same client address and can run
       into connection count and/or rate limits falsely.

       In this preliminary implementation, a count (or rate) lim-
       ited server can have only one remote client at a time.  If
       a  server  reports  multiple simultaneous clients, all but
       the last reported client are ignored.

<b>CONFIGURATION PARAMETERS</b>
       Changes to <b>main.cf</b> are picked up automatically as <a href="anvil.8.html">anvil(8)</a>
       processes  run  for only a limited amount of time. Use the
       command "<b>postfix reload</b>" to speed up a change.

       The text below provides  only  a  parameter  summary.  See
       <a href="postconf.5.html">postconf(5)</a> for more details including examples.

       <b><a href="postconf.5.html#config_directory">config_direc</a><a href="postconf.5.html#config_directory">tory</a> (see 'postconf -d' output)</b>
              The  default  location  of  the Postfix main.cf and
              master.cf configuration files.

       <b><a href="postconf.5.html#daemon_timeout">daemon_timeout</a> (18000s)</b>
              How much time a Postfix daemon process may take  to
              handle  a  request  before  it  is  terminated by a
              built-in watchdog timer.

       <b><a href="postconf.5.html#client_rate_time_unit">client_rate_time_unit</a> (60s)</b>
              The time unit over which  client  connection  rates
              and other rates are calculated.

       <b><a href="postconf.5.html#client_event_status_update_time">client_event_status_update_time</a> (600s)</b>
              How  frequently  the  <a href="anvil.8.html">anvil(8)</a>  connection and rate
              limiting server logs peak usage information.

       <b><a href="postconf.5.html#ipc_timeout">ipc_timeout</a> (3600s)</b>
              The time limit for sending or receiving information
              over an internal communication channel.

       <b><a href="postconf.5.html#max_idle">max_idle</a> (100s)</b>
              The  maximum  amount  of  time that an idle Postfix
              daemon process waits for the next  service  request
              before exiting.

       <b><a href="postconf.5.html#max_use">max_use</a> (100)</b>
              The  maximal number of connection requests before a
              Postfix daemon process terminates.

       <b><a href="postconf.5.html#process_id">process_id</a> (read-only)</b>
              The process ID of a Postfix command or daemon  pro-
              cess.

       <b><a href="postconf.5.html#process_name">process_name</a> (read-only)</b>
              The  process  name  of  a Postfix command or daemon
              process.

<b>SEE ALSO</b>
       <a href="postconf.5.html">postconf(5)</a> configuration parameters
       <a href="smtpd.8.html">smtpd(8)</a> Postfix SMTP server

<b>LICENSE</b>
       The Secure Mailer license must be  distributed  with  this
       software.

<b>HISTORY</b>
       The anvil service was introduced with Postfix 2.1.

<b>AUTHOR(S)</b>
       Wietse Venema
       IBM T.J. Watson Research
       P.O. Box 704
       Yorktown Heights, NY 10598, USA

                                                         ANVIL(8)
</pre> </body> </html>
