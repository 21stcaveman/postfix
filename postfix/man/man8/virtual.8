.TH VIRTUAL 8 
.ad
.fi
.SH NAME
virtual
\-
Postfix virtual mail delivery
.SH SYNOPSIS
.na
.nf
\fBvirtual\fR [generic Postfix daemon options]
.SH DESCRIPTION
.ad
.fi
The \fBvirtual\fR daemon processes delivery requests from the
Postfix queue manager to deliver mail to virtual local recipients.
Each delivery request specifies a queue file, a sender address,
a domain or host to deliver to, and one or more recipients.
This program expects to be run from the \fBmaster\fR(8) process
manager.

This daemon is designed for ISP's offering virtual mail hosting
services. Originally based on the local delivery agent, this agent
locates user mailboxes via map lookups of the full recipient
address, rather than hard-coded unix password file searches of
the local part only.

The \fBvirtual\fR daemon updates queue files and marks recipients
as finished, or it informs the queue manager that delivery should
be tried again at a later time. Delivery problem reports are sent
to the \fBbounce\fR(8) or \fBdefer\fR(8) daemon as appropriate.
.SH MAILBOX DELIVERY
.na
.nf
.ad
.fi
The default per-user mailbox is a file in the UNIX mail spool
directory (\fB/var/mail/\fIuser\fR or \fB/var/spool/mail/\fIuser\fR);
the location can be specified with the \fBmail_spool_directory\fR
configuration parameter.

In the case of UNIX-style mailbox delivery,
the \fBlocal\fR daemon prepends a "\fBFrom \fIsender time_stamp\fR"
envelope header to each message, prepends a \fBDelivered-To:\fR header
with the envelope recipient address, prepends a \fBReturn-Path:\fR
header with the envelope sender address, prepends a \fB>\fR character
to lines beginning with "\fBFrom \fR", and appends an empty line.
The mailbox is locked for exclusive access while delivery is in
progress. In case of problems, an attempt is made to truncate the
mailbox to its original length.

In the case of \fBmaildir\fR delivery, the local daemon prepends
a \fBDelivered-To:\fR header with the envelope recipient address
and prepends a \fBReturn-Path:\fR header with the envelope sender
address.
.SH DELIVERY RIGHTS
.na
.nf
.ad
.fi
Deliveries to mailboxes are made with the rights of the receiving
user on whose behalf the delivery is made.
.SH STANDARDS
.na
.nf
RFC 822 (ARPA Internet Text Messages)
.SH DIAGNOSTICS
.ad
.fi
Problems and transactions are logged to \fBsyslogd\fR(8).
Corrupted message files are marked so that the queue
manager can move them to the \fBcorrupt\fR queue afterwards.

Depending on the setting of the \fBnotify_classes\fR parameter,
the postmaster is notified of bounces and of other trouble.
.SH CONFIGURATION PARAMETERS
.na
.nf
.ad
.fi
The following \fBmain.cf\fR parameters are especially relevant to
this program. See the Postfix \fBmain.cf\fR file for syntax details
and for default values. Use the \fBpostfix reload\fR command after
a configuration change.
.SH Mailbox delivery
.ad
.fi
.IP \fBvirtual_mailbox_base\fR
Specifies a path that is prepended to all mailbox paths. This is
a safety measure to ensure an out of control map doesn't litter
the filesystem with mailboxes. While it could be set to "/",
this isn't recommended.
.IP \fBvirtual_mailbox_maps\fR
Recipients are looked up in this map to determine the path
to their mailbox. If the returned path ends in a slash
("/"), maildir-style delivery is carried out, otherwise
the path is assumed to specify a mailbox file. Note that
\fBvirtual_mailbox_base\fR is unconditionally prepended to
this path.
.IP \fBvirtual_minimum_uid\fR
Specifies a minimum uid that will be accepted as a return from
a \fBvirtual_uid_maps\fR lookup. Returned values less than this
will be rejected, and the message will be deferred.
.IP \fBvirtual_uid_maps\fR
Recipients are looked up in this map to determine the UID to be
used when writing to the target mailbox.
.IP \fBvirtual_gid_maps\fR
Recipients are looked up in this map to determine the GID to be
used when writing to the target mailbox.
.SH "Locking controls"
.ad
.fi
.IP \fBmailbox_delivery_lock\fR
How to lock UNIX-style mailboxes: one or more of \fBflock\fR,
\fBfcntl\fR or \fBdotlock\fR.
.IP \fBdeliver_lock_attempts\fR
Limit the number of attempts to acquire an exclusive lock
on a mailbox file.
.IP \fBdeliver_lock_delay\fR
Time in seconds between successive attempts to acquire
an exclusive lock on a mailbox file.
.IP \fBstale_lock_time\fR
Limit the time after which a stale lockfile is removed.
.SH "Resource controls"
.ad
.fi
.IP \fBvirtual_destination_concurrency_limit\fR
Limit the number of parallel deliveries to the same domain.
The default limit is taken from the
\fBdefault_destination_concurrency_limit\fR parameter.
.IP \fBvirtual_destination_recipient_limit\fR
Limit the number of recipients per message delivery.
The default limit is taken from the
\fBdefault_destination_recipient_limit\fR parameter.
.SH HISTORY
.na
.nf
.ad
.fi
This agent was originally based on the local delivery
agent. Modifications mainly consisted of removing code that wasn't
applicable or wasn't safe in this context (aliases, .forwards,
program aliases).

The \fBDelivered-To:\fR header appears in the \fBqmail\fR system
by Daniel Bernstein.

The \fImaildir\fR structure appears in the \fBqmail\fR system
by Daniel Bernstein.
.SH SEE ALSO
.na
.nf
bounce(8) non-delivery status reports
syslogd(8) system logging
qmgr(8) queue manager
.SH LICENSE
.na
.nf
.ad
.fi
The Secure Mailer license must be distributed with this software.
.SH AUTHOR(S)
.na
.nf
Wietse Venema
IBM T.J. Watson Research
P.O. Box 704
Yorktown Heights, NY 10598, USA

Andrew McNamara
andrewm@connect.com.au
connect.com.au Pty. Ltd.
Level 3, 213 Miller St
North Sydney 2060, NSW, Australia
