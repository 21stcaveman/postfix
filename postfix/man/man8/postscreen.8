.TH POSTSCREEN 8 
.ad
.fi
.SH NAME
postscreen
\-
Postfix SMTP triage server
.SH "SYNOPSIS"
.na
.nf
\fBpostscreen\fR [generic Postfix daemon options]
.SH DESCRIPTION
.ad
.fi
The Postfix \fBpostscreen\fR(8) server performs triage on
multiple inbound SMTP connections in parallel. While
\fBpostscreen\fR(8) keeps zombies and other bogus clients
away from Postfix SMTP server processes, more Postfix SMTP
server processes remain available for legitimate clients.
.SH "GENERAL OPERATION"
.na
.nf
.ad
.fi
The triage process involves a number of tests, in the order
as described below.  Some tests introduce a delay of a few
seconds.  Once a client passes all tests, its IP address
is temporarily excluded from the tests, typically for 24
hours.  This minimizes the impact of the tests on legitimate
mail clients.

After logging the result of its tests, \fBpostscreen\fR(8)
by default forwards all connections to a real SMTP server
process. This mode is useful for non-destructive testing.

In a typical production setting, \fBpostscreen\fR(8) is
configured to disconnect clients that fail some tests.  A
future implementation may pass the connection to a dummy
SMTP protocol engine that logs sender and recipient information
before hanging up.

Note: \fBpostscreen\fR(8) is not an SMTP proxy; this is
intentional. The purpose is to prioritize legitimate clients
with as little overhead as possible.
.SH 1. PERMANENT WHITELIST TEST
.ad
.fi
The postscreen_whitelist_networks parameter (default:
$mynetworks) specifies a permanent whitelist for SMTP client
IP addresses.

When the SMTP client address matches the permanent whitelist,
this is logged as:
.sp
.nf
\fBWHITELISTED \fIaddress\fR
.fi
.sp
The action is not configurable: immediately forward the
connection to a real SMTP server process.
.SH 2. PERMANENT BLACKLIST TEST
.ad
.fi
The postscreen_blacklist_networks parameter (default: empty)
specifies a permanent blacklist for SMTP client IP addresses.
The address syntax is as with mynetworks.

When the SMTP client address matches the permanent blacklist,
this is logged as:
.sp
.nf
\fBBLACKLISTED \fIaddress\fR
.fi
.sp
The postscreen_blacklist_action parameter specifies the
action that is taken next:
.IP "\fBcontinue\fR (default)"
Continue with the SMTP GREETING PHASE TESTS below.
.IP \fBdrop\fR
Drop the connection immediately with a 521 SMTP reply.  In
a future implementation, the connection may instead be
passed to a dummy SMTP protocol engine that logs sender and
recipient information.
.SH 3. TEMPORARY WHITELIST TEST
.ad
.fi
The \fBpostscreen\fR(8) daemon maintains a \fItemporary\fR
whitelist for SMTP client IP addresses that have passed all
the tests described below. The postscreen_cache_map parameter
specifies the location of the temporary whitelist.  The
temporary whitelist is not used for SMTP client addresses
that appear on the \fIpermanent\fR blacklist or whitelist.

When the SMTP client address appears on the temporary
whitelist, this is logged as:
.sp
.nf
\fBPASS OLD \fIaddress\fR
.fi
.sp
The action is not configurable: immediately forward the
connection to a real SMTP server process.  The client is
excluded from further tests until its temporary whitelist
entry expires, as controlled with the postscreen_cache_ttl
parameter.  Expired entries are silently renewed if possible.
.SH 4. SMTP GREETING PHASE TESTS
.ad
.fi
The postscreen_greet_wait parameter specifies a time interval
during which \fBpostscreen\fR(8) runs a number of tests in
parallel.  These tests are described below, and are run
before the client may see the real SMTP server's "220
text..." server greeting.

When the SMTP client passes all greeting-phase tests, this
is logged as:
.sp
.nf
\fBPASS NEW \fIaddress\fR
.fi
.sp
The action is to forward the connection to a real SMTP
server process and to create a temporary whitelist entry
that excludes the client IP address from further tests until
the temporary whitelist entry expires, as controlled with
the postscreen_cache_ttl parameter.

In a future implementation, the connection may first be passed to
a dummy SMTP protocol engine that implements more protocol
tests including greylisting, before the client is allowed
to talk to a real SMTP server process.
.SH 4A. PREGREET TEST
.ad
.fi
The postscreen_greet_banner parameter specifies the \fItext\fR
portion of a "220-\fItext\fR..." teaser banner (default:
$smtpd_banner).
The \fBpostscreen\fR(8) daemon sends this before the
postscreen_greet_wait timer is started.  The purpose of the
teaser banner is to confuse SPAM clients so that they speak
before their turn. It has no effect on SMTP clients that
correctly implement the protocol.

To avoid problems with broken SMTP engines in network
appliances, either exclude them from all tests with the
postscreen_whitelist_networks feature or else specify an
empty postscreen_greet_banner value to disable the "220-text..."
teaser banner.

When an SMTP client sends a command before the
postscreen_greet_wait time has elapsed, this is logged as:
.sp
.nf
\fBPREGREET \fIcount \fBafter \fItime \fBfrom \fIaddress text...\fR
.fi
.sp
Translation: the client at \fIaddress\fR sent \fIcount\fR
bytes before its turn to speak, and this happened \fItime\fR
seconds after the postscreen_greet_wait timer was started.
The \fItext\fR is what the client sent (truncated to 100
bytes, and with non-printable characters replaced with "?").

The postscreen_greet_action parameter specifies the action
that is taken next:
.IP "\fBcontinue\fR (default)"
Wait until the postscreen_greet_wait time has elapsed, then
report DNSBL lookup results if applicable. Either perform
DNSBL-related actions or forward the connection to a real
SMTP server process.
.IP \fBdrop\fR
Drop the connection immediately with a 521 SMTP reply.
In a future implementation, the connection may instead be passed
to a dummy SMTP protocol engine that logs sender and recipient
information.
.SH 4B. HANGUP TEST
.ad
.fi
When the SMTP client hangs up without sending any data
before the postscreen_greet_wait time has elapsed, this is
logged as:
.sp
.nf
\fBHANGUP after \fItime \fBfrom \fIaddress\fR
.fi
.sp
The postscreen_hangup_action specifies the action
that is taken next:
.IP "\fBcontinue\fR (default)"
Wait until the postscreen_greet_wait time has elapsed, then
report DNSBL lookup results if applicable. Do not forward
the broken connection to a real SMTP server process.
.IP \fBdrop\fR
Drop the connection immediately.
.SH 4C. DNS BLOCKLIST TEST
.ad
.fi
The postscreen_dnsbl_sites parameter (default: empty)
specifies a list of DNS blocklist servers. These lookups
are made in parallel.

When the postscreen_greet_wait time has elapsed, and the
SMTP client address is listed with at least one of these
blocklists, this is logged as:
.sp
.nf
\fBDNSBL rank \fIcount \fBfor \fIaddress\fR
.fi
.sp
Translation: the client at \fIaddress\fR is listed with
\fIcount\fR DNSBL servers. The \fIcount\fR does not
depend on the number of DNS records that an individual DNSBL
server returns.

The postscreen_dnsbl_action parameter specifies the action
that is taken next:
.IP "\fBcontinue\fR (default)"
Forward the connection to a real SMTP server process.
.IP \fBdrop\fR
Drop the connection immediately with a 521 SMTP reply.
In a future implementation, the connection may instead be passed
to a dummy SMTP protocol engine that logs sender and recipient
information.
.SH "SECURITY"
.na
.nf
.ad
.fi
The \fBpostscreen\fR(8) server is moderately security-sensitive.
It talks to untrusted clients on the network. The process
can be run chrooted at fixed low privilege.
.SH "STANDARDS"
.na
.nf
RFC 5321 (SMTP, including multi-line 220 greetings)
RFC 2920 (SMTP Pipelining)
.SH DIAGNOSTICS
.ad
.fi
Problems and transactions are logged to \fBsyslogd\fR(8).
.SH "CONFIGURATION PARAMETERS"
.na
.nf
.ad
.fi
Changes to main.cf are not picked up automatically, as
\fBpostscreen\fR(8) processes may run for several hours.
Use the command "postfix reload" after a configuration
change.

The text below provides only a parameter summary. See
\fBpostconf\fR(5) for more details including examples.
.SH "TRIAGE PARAMETERS"
.na
.nf
.ad
.fi
.IP "\fBpostscreen_blacklist_action (continue)\fR"
The action that \fBpostscreen\fR(8) takes when an SMTP client is
permanently blacklisted with the postscreen_blacklist_networks
parameter.
.IP "\fBpostscreen_blacklist_networks (empty)\fR"
Network addresses that are permanently blacklisted; see the
postscreen_blacklist_action parameter for possible actions.
.IP "\fBpostscreen_dnsbl_action (continue)\fR"
The action that \fBpostscreen\fR(8) takes when an SMTP client is listed
at the DNS blocklist domains specified with the postscreen_dnsbl_sites
parameter.
.IP "\fBpostscreen_dnsbl_sites (empty)\fR"
Optional list of DNS blocklist domains.
.IP "\fBpostscreen_greet_action (continue)\fR"
The action that \fBpostscreen\fR(8) takes when an SMTP client speaks
before its turn within the time specified with the postscreen_greet_wait
parameter.
.IP "\fBpostscreen_greet_banner ($smtpd_banner)\fR"
The \fItext\fR in the optional "220-\fItext\fR..." server
response that
\fBpostscreen\fR(8) sends ahead of the real Postfix SMTP server's "220
text..." response, in an attempt to confuse bad SMTP clients so
that they speak before their turn (pre-greet).
.IP "\fBpostscreen_greet_wait (4s)\fR"
The amount of time that \fBpostscreen\fR(8) will wait for an SMTP
client to send a command before its turn, and for DNS blocklist
lookup results to arrive.
.IP "\fBpostscreen_hangup_action (continue)\fR"
The action that \fBpostscreen\fR(8) takes when an SMTP client disconnects
without sending data, within the time specified with the
postscreen_greet_wait parameter.
.IP "\fBpostscreen_post_queue_limit ($default_process_limit)\fR"
The number of clients that can be waiting for service from a
real SMTP server process.
.IP "\fBpostscreen_pre_queue_limit ($default_process_limit)\fR"
The number of non-whitelisted clients that can be waiting for
a decision whether they will receive service from a real SMTP server
process.
.IP "\fBpostscreen_whitelist_networks ($mynetworks)\fR"
Network addresses that are permanently whitelisted, and that
will not be subjected to \fBpostscreen\fR(8) checks.
.IP "\fBsmtpd_service (smtpd)\fR"
The internal service that \fBpostscreen\fR(8) forwards allowed
connections to.
.SH "CACHE CONTROLS"
.na
.nf
.ad
.fi
.IP "\fBpostscreen_cache_cleanup_interval (12h)\fR"
The amount of time between \fBpostscreen\fR(8) cache cleanup runs.
.IP "\fBpostscreen_cache_map (btree:$data_directory/ps_whitelist)\fR"
Persistent storage for the \fBpostscreen\fR(8) server decisions.
.IP "\fBpostscreen_cache_retention_time (1d)\fR"
The amount of time that \fBpostscreen\fR(8) will cache an expired
temporary whitelist entry before it is removed.
.IP "\fBpostscreen_cache_ttl (1d)\fR"
The amount of time that \fBpostscreen\fR(8) will cache a decision for
a specific SMTP client IP address.
.SH "MISCELLANEOUS CONTROLS"
.na
.nf
.ad
.fi
.IP "\fBconfig_directory (see 'postconf -d' output)\fR"
The default location of the Postfix main.cf and master.cf
configuration files.
.IP "\fBdaemon_timeout (18000s)\fR"
How much time a Postfix daemon process may take to handle a
request before it is terminated by a built-in watchdog timer.
.IP "\fBdelay_logging_resolution_limit (2)\fR"
The maximal number of digits after the decimal point when logging
sub-second delay values.
.IP "\fBcommand_directory (see 'postconf -d' output)\fR"
The location of all postfix administrative commands.
.IP "\fBipc_timeout (3600s)\fR"
The time limit for sending or receiving information over an internal
communication channel.
.IP "\fBmax_idle (100s)\fR"
The maximum amount of time that an idle Postfix daemon process waits
for an incoming connection before terminating voluntarily.
.IP "\fBprocess_id (read-only)\fR"
The process ID of a Postfix command or daemon process.
.IP "\fBprocess_name (read-only)\fR"
The process name of a Postfix command or daemon process.
.IP "\fBsyslog_facility (mail)\fR"
The syslog facility of Postfix logging.
.IP "\fBsyslog_name (see 'postconf -d' output)\fR"
The mail system name that is prepended to the process name in syslog
records, so that "smtpd" becomes, for example, "postfix/smtpd".
.SH "SEE ALSO"
.na
.nf
smtpd(8), Postfix SMTP server
dnsblog(8), temporary DNS helper
syslogd(8), system logging
.SH "LICENSE"
.na
.nf
.ad
.fi
The Secure Mailer license must be distributed with this software.
.SH "AUTHOR(S)"
.na
.nf
Wietse Venema
IBM T.J. Watson Research
P.O. Box 704
Yorktown Heights, NY 10598, USA
