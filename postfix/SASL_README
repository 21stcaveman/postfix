WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING
===============================================================

Do not use this code. In its present form, the cyrus SASL library
software is light years away from production quality - not enough
documentation to figure out how the software is supposed to work,
and not enough error checking to find out why it fails.  That is
unacceptable for a security-sensitive application.

Contrary to expectation, this code works only LINUX.  If you build
Postfix+SASL on other systems, the software builds without trouble,
but crashes in mysterious ways when you attempt to use it, and can
be made to work only with a considerable amount of tweaking.

Introduction
============

The Postfix SASL support according to RFC 2554 was originally
implemented by Till Franke of SuSE Rhein/Main AG.  The present code
is a much trimmed-down implementation of only the bare necessities
for SMTP clients and servers. When receiving mail, Postfix logs
the client-provided username and sender address to the maillog
file, but does not include that information in message headers.
It is no-one's business what username and authentication method
the poster was using in order to access the mail server.

Building the SASL library
=========================

Postfix appears to work with cyrus-sasl-1.5.5, which is available
from:

    ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/

IMPORTANT: if you install the sasl libraries as per the default,
you will have to symlink /usr/lib/sasl -> /usr/local/lib/sasl.

Building Postfix with SASL authentication support
=================================================

To build Postfix with SASL authentication support, the following
assumes that the SASL include files are in /usr/local/include, and
that the SASL libraries are in /usr/local/lib.

On some systems this generates the necessary Makefile definitions:

    % make makefiles CCARGS=-DUSE_SASL_AUTH" -I/usr/local/include" \
	AUXLIBS="-L/usr/local/lib -lsasl"

On Solaris 2.x you need to specify run-time link information,
otherwise ld.so will not find the SASL shared library:

    % make makefiles CCARGS=-DUSE_SASL_AUTH" -I/usr/local/include" \
	AUXLIBS="-L/usr/local/lib -R/usr/local/lib -lsasl"

Enabling SASL authentication in the SMTP server
===============================================

See conf/sample-sasl.cf for examples. 

    /etc/postfix/main.cf:
	smtpd_sasl_auth_enable = yes

In order to allow mail relaying by authenticated clients:

    /etc/postfix/main.cf:
	smtpd_recipient_restrictions = 
	    permit_mynetworks permit_sasl_authenticated ...

In /usr/local/lib/sasl/smtpd.conf you need to specify what authentication
mechanism the server will support, for example:

    pwcheck_method:  shadow

This will use the Linux shadow passwd file, which is in fact the
only way that I was able to test, but which is undesirable from a
security point of view because it uses clear-text passwords.

To test, connect to the SMTP server, and you should be able to have
a conversation like this:

    220 server.host.name ESMTP Postfix
    EHLO client.host.name
    250-server.host.name
    250-PIPELINING
    250-SIZE 10240000
    250-ETRN
    250-AUTH DIGEST-MD5 PLAIN CRAM-MD5
    250 8BITMIME
    AUTH PLAIN dGVzdAB0ZXN0AHRlc3RwYXNz
    235 Authentication successful

Instead of dGVzdAB0ZXN0AHRlc3RwYXNz, specify the base64 encoded
form of username\0username\0password. The example above is for a
user named test with password testpass.

Enabling SASL authentication in the SMTP client
===============================================

Turn on client-side SASL authentication, and specify a table with
per-host username and password information.

    /etc/postfix/main.cf:
	smtp_sasl_auth_enable = yes
	smtp_sasl_passwd_maps = hash:/etc/postfix/sasl_passwd

    /etc/postfix/sasl_passwd:
	host.domain	username:password
	host.domain	username

The SASL password file is opened before the SMTP server enters the
optional chroot jail, so there is no need to copy the sasl_passwd
file into /var/spool/postfix/etc/postfix.
