
    /*
     * Postfix keeps all information related to an email message is in a
     * write-once file, including the envelope sender and recipients, and the
     * message content. This design maximizes robustness: one file is easier
     * to keep track of than multiple files, and write-once means that no
     * operation ever needs to be undone. This design also minimizes file
     * system overhead, because creating and removing files is relatively
     * expensive compared to writing files. Separate files are used for
     * logging the causes of deferral or failed delivery.
     * 
     * A Postfix queue file consists of three segments.
     * 
     * 1) The initial envelope segment with the arrival time, sender address,
     * recipients, and some other stuff that can be recorded before the
     * message content is received, including non-recipient information that
     * results from actions in Postfix SMTP server access tables. In this
     * segment, recipient records may be preceded or followed by
     * non-recipient records.
     * 
     * 2) The message content segment with the message headers and body. The
     * message body includes all the MIME segments, if there are any.
     * 
     * 3) The extracted envelope segment with information that was extracted
     * from message headers or from the message body, including recipient
     * addresses that were extracted from message headers, and non-recipient
     * information that results from actions in header/body_checks patterns.
     * In this segment, all non-recipient records precede the recipient
     * records. The last non-recipient records are return-receipt-to and
     * errors-to.
     * 
     * There are two queue file layouts.
     * 
     * A) All recipient records are in the initial envelope segment, except for
     * the optional always_bcc recipient which is always stored in the
     * extracted envelope segment. The queue manager reads as many recipients
     * as it can from the initial envelope segment, and then examines all
     * remaining initial envelope records and all extracted envelope records,
     * picking up non-recipient information. This organization favors
     * messages with fewer than $qmgr_active_recipient_limit recipients.
     * 
     * B) All recipient records are stored in the extracted envelope segment,
     * after all non-recipient records. The queue manager is guaranteed to
     * have read all the non-recipient records before it sees the first
     * recipient record. This organization can handle messages with very
     * large numbers of recipients.
     * 
     * All this is the result of an evolutionary process, where compatibility
     * between Postfix versions was a major goal as new features were added.
     * Therefore the file organization is not optimal from a performance
     * point of view. In hindsight, the non-recipient information that
     * follows recipients in the initial envelope segment could be moved to
     * the extracted envelope segment. This would improve file organization
     * A)'s performance with very large numbers of recipients, by eliminating
     * the need to examine all initial envelope records before starting
     * deliveries.
     */
